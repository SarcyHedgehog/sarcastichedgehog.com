<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buzzer!</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@multisynq/client@latest/bundled/multisynq-client.min.js"></script>
    <script src="config.js"></script>
    <script>
        if (!window.APP_CONFIG) { console.warn("config.js not found..."); window.APP_CONFIG = { API_KEY: "placeholder", APP_ID: "placeholder" }; }
    </script>
    <style>
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translate(-50%,-50%) scale(0.8); } 10%, 90% { opacity: 1; transform: translate(-50%,-50%) scale(1); } }
        .fade-in-out { display: none; animation: fadeInOut 3s forwards; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-hidden">

    <!-- LOBBY SCREEN -->
    <div id="lobby-screen" class="flex flex-col h-screen items-center justify-center p-4">
        <h1 class="text-6xl font-bold mb-8 text-cyan-400">BUZZER!</h1>
        <input id="name-input" type="text" placeholder="Enter Your Name" class="text-center text-xl w-full max-w-sm p-4 rounded-lg bg-slate-700 text-white border-2 border-slate-600 focus:border-cyan-400 focus:outline-none mb-4">
        <div id="join-create-buttons" class="w-full max-w-sm space-y-4">
            <button id="show-create-button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold text-2xl py-4 rounded-lg shadow-lg transition-transform active:scale-95">Create New Game</button>
            <button id="show-join-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold text-2xl py-4 rounded-lg shadow-lg transition-transform active:scale-95">Join Existing Game</button>
        </div>
        <div id="code-entry" class="hidden w-full max-w-sm space-y-4">
            <input id="code-input" type="text" placeholder="Enter Game Code" class="text-center text-xl w-full p-4 rounded-lg bg-slate-700 text-white border-2 border-slate-600 focus:border-cyan-400 focus:outline-none" autocapitalize="off" autocomplete="off">
            <button id="go-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold text-2xl py-4 rounded-lg shadow-lg transition-transform active:scale-95">Let's Go!</button>
            <button id="back-button" class="w-full text-slate-400 hover:text-white pt-2">Back</button>
        </div>
        
        <!-- *** NEW: PWA Install buttons/helpers *** -->
        <button id="install-button" class="hidden mt-8 bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg font-bold">Install App</button>
        <div id="ios-install-helper" class="hidden mt-8 text-center bg-indigo-900/50 p-3 rounded-lg max-w-sm">
            <p>To install, tap the <span class="font-bold">Share</span> button <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block -mt-1"><path d="M13 4.5a2.5 2.5 0 1 1 .752 4.256l-3.32 1.51a2.503 2.503 0 0 1 0 1.468l3.32 1.51A2.5 2.5 0 1 1 14.5 16a2.5 2.5 0 0 1-.752-4.256L10.428 10l3.32-1.51A2.5 2.5 0 0 1 13 4.5Z M4.5 8a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z" /></svg> then choose <span class="font-bold">'Add to Home Screen'</span>.</p>
        </div>
    </div>

    <!-- The rest of the HTML is identical to the last version -->
    <div id="game-screen" class="hidden flex-col h-screen p-4"> <div class="flex-shrink-0 text-center mb-4"> <p id="question-header" class="text-2xl font-semibold text-slate-300">Game Lobby</p> <p id="player-status" class="text-xl text-cyan-400 h-7">Waiting for Host...</p> </div> <div id="last-question-feedback" class="hidden text-center text-lg mb-4 p-2 bg-slate-800 rounded-md"></div> <div class="flex-grow flex flex-col justify-center items-center space-y-4"> <button id="tick-button" class="w-full max-w-md h-1/3 bg-green-500 text-8xl font-black rounded-2xl shadow-xl flex items-center justify-center transition-transform active:scale-95 disabled:opacity-50">✓</button> <button id="cross-button" class="w-full max-w-md h-1/3 bg-red-500 text-8xl font-black rounded-2xl shadow-xl flex items-center justify-center transition-transform active:scale-95 disabled:opacity-50">✗</button> </div> <div id="host-info-screen" class="hidden flex-grow flex-col bg-slate-800/80 p-2 rounded-lg mt-4 overflow-hidden"> <h2 class="text-center text-xl font-bold text-cyan-400 mb-2">Players in Game</h2> <div id="player-list" class="flex-grow overflow-y-auto space-y-2"></div> </div> <div id="footer-controls" class="flex-shrink-0 flex items-center justify-center space-x-4 p-4"> <button id="host-button" class="bg-amber-500 hover:bg-amber-600 px-8 py-3 rounded-lg font-bold text-xl transition-transform active:scale-95">Host</button> <button id="start-game-button" class="hidden bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-bold text-xl transition-transform active:scale-95 disabled:opacity-50">Start Game</button> <button id="end-button" class="hidden bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-bold text-xl transition-transform active:scale-95">End</button> <button id="next-question-button" class="hidden bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-bold text-xl transition-transform active:scale-95 disabled:opacity-50">Next Question</button> <button id="copy-info-button" class="hidden bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-bold text-lg transition-transform active:scale-95">Copy Info</button> </div> </div>
    <div id="game-over-screen" class="hidden flex-col h-screen items-center justify-center p-4"> <h1 class="text-5xl font-bold mb-6 text-cyan-400">Final Scores</h1> <div id="final-scores-list" class="w-full max-w-md bg-slate-800 p-4 rounded-lg overflow-y-auto space-y-3"></div> <button id="unhost-button" class="hidden mt-6 bg-slate-500 hover:bg-slate-600 px-8 py-3 rounded-lg font-bold text-xl transition-transform active:scale-95">Reset and Unhost</button> </div>

    <script type="module">
        // All JavaScript is the same as the previous correct version, but with the new PWA logic in the AppController.
        class GameModel extends Multisynq.Model {
            init() { this.players = new Map(); this.gameState = 'LOBBY'; this.hostViewId = null; this.questionNumber = 0; this.currentCorrectAnswer = null; this.lastRoundCorrectAnswer = null; this.subscribe(this.sessionId, "view-join", "viewJoined"); this.subscribe(this.sessionId, "view-exit", "viewExited"); this.subscribe(this.id, "claimHost", "claimHost"); this.subscribe(this.id, "startGame", "startGame"); this.subscribe(this.id, "setAnswer", "setAnswer"); this.subscribe(this.id, "playerAnswer", "playerAnswer"); this.subscribe(this.id, "nextQuestion", "nextQuestion"); this.subscribe(this.id, "endGame", "endGame"); this.subscribe(this.id, "resetGame", "resetGame"); }
            viewJoined(p) { const n = PlayerModel.create({ viewId: p.viewId, name: p.viewData.name }); this.players.set(p.viewId, n); this.publish(this.id, "players-updated"); }
            viewExited(p) { const n = this.players.get(p.viewId); if(n) { if (this.hostViewId === p.viewId) this.resetGame(); n.destroy(); this.players.delete(p.viewId); this.publish(this.id, "players-updated"); }}
            claimHost(v) { if (this.hostViewId) return; this.hostViewId = v; this.publish(this.id, "state-changed", this.gameState); this.publish(this.id, "players-updated");}
            startGame() { if (this.gameState !== 'LOBBY' || this.players.size < 2) return; this.goToNextRound(); }
            setAnswer(a) { if (this.gameState !== 'QUESTION_SETUP') return; this.currentCorrectAnswer = a; this.gameState = 'TAKING_ANSWERS'; this.publish(this.id, "state-changed", this.gameState); }
            playerAnswer(p) { if (this.gameState !== 'TAKING_ANSWERS') return; const n = this.players.get(p.viewId); if (n && n.currentAnswer === null) { n.currentAnswer = p.answer; this.publish(this.id, "players-updated"); }}
            nextQuestion() { if (this.gameState !== 'TAKING_ANSWERS') return; this.lastRoundCorrectAnswer = this.currentCorrectAnswer; this.players.forEach(p => { p.lastAnswerSubmitted = p.currentAnswer; if (p.currentAnswer !== null) { p.lastAnswerCorrect = (p.currentAnswer === this.currentCorrectAnswer); if (p.lastAnswerCorrect) p.score++; }}); this.publish(this.id, "players-updated"); this.goToNextRound(); }
            goToNextRound() { this.questionNumber++; this.currentCorrectAnswer = null; this.players.forEach(p => { p.currentAnswer = null; }); this.gameState = 'QUESTION_SETUP'; this.publish(this.id, "state-changed", this.gameState); this.publish(this.id, "players-updated"); }
            endGame() { this.gameState = 'GAME_OVER'; this.publish(this.id, "state-changed", this.gameState); }
            resetGame() { this.hostViewId = null; this.questionNumber = 0; this.currentCorrectAnswer = null; this.lastRoundCorrectAnswer = null; this.players.forEach(p => { p.score = 0; p.currentAnswer = null; p.lastAnswerCorrect = null; p.lastAnswerSubmitted = null; }); this.gameState = 'LOBBY'; this.publish(this.id, "state-changed", this.gameState); this.publish(this.id, "players-updated"); }
        }
        GameModel.register("GameModel");
        class PlayerModel extends Multisynq.Model { init(p) { this.viewId = p.viewId; this.name = p.name; this.score = 0; this.currentAnswer = null; this.lastAnswerCorrect = null; this.lastAnswerSubmitted = null; } }
        PlayerModel.register("PlayerModel");

        class GameView extends Multisynq.View {
            constructor(model) { super(model); this.gameModel = model; this.dom = { lobby: document.getElementById('lobby-screen'), game: document.getElementById('game-screen'), gameOver: document.getElementById('game-over-screen'), hostInfo: document.getElementById('host-info-screen'), tickButton: document.getElementById('tick-button'), crossButton: document.getElementById('cross-button'), playerStatus: document.getElementById('player-status'), questionHeader: document.getElementById('question-header'), questionNumber: document.getElementById('question-number'), playerList: document.getElementById('player-list'), finalScoresList: document.getElementById('final-scores-list'), hostButton: document.getElementById('host-button'), startGameButton: document.getElementById('start-game-button'), endButton: document.getElementById('end-button'), nextQuestionButton: document.getElementById('next-question-button'), unhostButton: document.getElementById('unhost-button'), copyInfoButton: document.getElementById('copy-info-button'), lastQuestionFeedback: document.getElementById('last-question-feedback') }; this.dom.lobby.classList.add('hidden'); this.dom.game.classList.remove('hidden'); this.dom.game.classList.add('flex'); this.setupEventListeners(); this.subscribe(this.gameModel.id, "players-updated", () => this.updateOnPlayersChanged()); this.subscribe(this.gameModel.id, "state-changed", (s) => this.updateUIForNewState(s)); this.updateUIForNewState(this.gameModel.gameState); this.updatePlayerList(); }
            setupEventListeners() { this.dom.hostButton.addEventListener('click', () => this.publish(this.gameModel.id, "claimHost", this.viewId)); this.dom.startGameButton.addEventListener('click', () => this.publish(this.gameModel.id, "startGame")); this.dom.endButton.addEventListener('click', () => this.publish(this.gameModel.id, "endGame")); this.dom.nextQuestionButton.addEventListener('click', () => this.publish(this.gameModel.id, "nextQuestion")); this.dom.unhostButton.addEventListener('click', () => this.publish(this.gameModel.id, "resetGame")); this.dom.copyInfoButton.addEventListener('click', () => this.copyInfoToClipboard()); const handleAnswer = (a) => { const p = this.gameModel.players.get(this.viewId); if (p && p.currentAnswer !== null) return; const isHost = this.viewId === this.gameModel.hostViewId; if (isHost && this.gameModel.gameState === 'QUESTION_SETUP') this.publish(this.gameModel.id, "setAnswer", a); else if (!isHost && this.gameModel.gameState === 'TAKING_ANSWERS') this.publish(this.gameModel.id, "playerAnswer", { viewId: this.viewId, answer: a }); }; this.dom.tickButton.addEventListener('click', () => handleAnswer(true)); this.dom.crossButton.addEventListener('click', () => handleAnswer(false)); }
            updateUIForNewState(newState) { const isHost = this.viewId === this.gameModel.hostViewId; this.dom.game.classList.toggle('hidden', newState === 'GAME_OVER'); this.dom.game.classList.toggle('flex', newState !== 'GAME_OVER'); this.dom.gameOver.classList.toggle('hidden', newState !== 'GAME_OVER'); this.dom.gameOver.classList.toggle('flex', newState === 'GAME_OVER'); this.dom.hostInfo.classList.toggle('hidden', !isHost); this.dom.hostButton.classList.toggle('hidden', !!this.gameModel.hostViewId); this.dom.startGameButton.classList.toggle('hidden', !(isHost && newState === 'LOBBY')); this.dom.copyInfoButton.classList.toggle('hidden', !(isHost && newState === 'LOBBY')); this.dom.endButton.classList.toggle('hidden', !(isHost && (newState === 'QUESTION_SETUP' || newState === 'TAKING_ANSWERS'))); this.dom.nextQuestionButton.classList.toggle('hidden', !(isHost && newState === 'TAKING_ANSWERS')); this.dom.unhostButton.classList.toggle('hidden', !(isHost && newState === 'GAME_OVER')); this.dom.tickButton.disabled = true; this.dom.crossButton.disabled = true; this.dom.nextQuestionButton.disabled = true; this.dom.lastQuestionFeedback.classList.add('hidden'); const hostName = this.gameModel.hostViewId ? this.gameModel.players.get(this.gameModel.hostViewId)?.name : null; switch (newState) { case 'LOBBY': this.dom.questionHeader.textContent = "Game Lobby"; if(isHost) { this.dom.playerStatus.textContent = "Waiting for players..."; this.dom.startGameButton.disabled = this.gameModel.players.size < 2; } else { this.dom.playerStatus.textContent = hostName ? `${hostName} is host. Waiting...` : "Waiting for a host..."; } break; case 'QUESTION_SETUP': this.dom.questionHeader.textContent = `Question ${this.gameModel.questionNumber}`; this.dom.playerStatus.textContent = isHost ? "Choose the correct answer" : `${hostName} is setting up...`; if (isHost) { this.dom.tickButton.disabled = false; this.dom.crossButton.disabled = false; } this.showLastRoundFeedback(); break; case 'TAKING_ANSWERS': if (isHost) { this.dom.playerStatus.textContent = "Waiting for players..."; this.dom.nextQuestionButton.disabled = false; } else { this.dom.playerStatus.textContent = "What's the answer?"; this.dom.tickButton.disabled = false; this.dom.crossButton.disabled = false; } break; case 'GAME_OVER': this.renderFinalScores(); break; } this.updateBuzzerButtons(); }
            updateOnPlayersChanged() { this.updatePlayerList(); this.updateUIForNewState(this.gameModel.gameState); }
            updatePlayerList() { if (this.viewId === this.gameModel.hostViewId && this.gameModel.gameState === 'LOBBY') { this.dom.startGameButton.disabled = this.gameModel.players.size < 2; this.dom.playerStatus.textContent = this.gameModel.players.size < 2 ? "Waiting for 1 more player..." : "Ready! Press Start Game."; } const playersToList = [...this.gameModel.players.values()].filter(p => p.viewId !== this.viewId); const html = playersToList.length > 0 ? playersToList.sort((a,b)=>b.score-a.score).map(p => this.renderPlayerChip(p)).join('') : `<p class="text-slate-400 text-center italic mt-4">No other players have joined yet.</p>`; this.dom.playerList.innerHTML=html; }
            renderPlayerChip(p) { const i=p.currentAnswer===true?'✓':p.currentAnswer===false?'✗':'-'; const c=p.currentAnswer===true?'text-green-400':p.currentAnswer===false?'text-red-400':'text-slate-400'; return `<div class="flex items-center justify-between bg-slate-700 p-2 rounded-md"><span class="text-lg">${p.name}</span><div class="flex items-center space-x-4"><span class="text-2xl font-black ${c}">${i}</span><span class="text-lg font-bold w-10 text-right">${p.score}</span></div></div>`; }
            renderFinalScores() { const playersToScore = [...this.gameModel.players.values()]; const h=playersToScore.sort((a,b)=>b.score-a.score).map(p => `<div class="flex justify-between items-center text-xl p-3 rounded-lg bg-slate-700"><span class="${p.viewId===this.viewId?'text-cyan-400 font-bold':''}">${p.name}</span><span class="font-bold">${p.score}</span></div>`).join(''); this.dom.finalScoresList.innerHTML = h||`<p class="text-slate-400 text-center italic">No players to score.</p>`;}
            updateBuzzerButtons() { const myPlayer = this.gameModel.players.get(this.viewId); const answered = myPlayer?.currentAnswer !== null; const isTakingAnswers = this.gameModel.gameState === 'TAKING_ANSWERS'; const originalClasses = { tick: 'bg-green-500', cross: 'bg-red-500' }; const inactiveClass = 'bg-slate-600'; const selectedClasses = ['border-4', 'border-white']; this.dom.tickButton.classList.remove(inactiveClass, ...selectedClasses); this.dom.crossButton.classList.remove(inactiveClass, ...selectedClasses); this.dom.tickButton.classList.add(...originalClasses.tick.split(' ')); this.dom.crossButton.classList.add(...originalClasses.cross.split(' ')); if (this.viewId !== this.gameModel.hostViewId && isTakingAnswers && answered) { if(myPlayer.currentAnswer === true) { this.dom.tickButton.classList.add(...selectedClasses); this.dom.crossButton.classList.remove(...originalClasses.cross.split(' ')); this.dom.crossButton.classList.add(inactiveClass); } else { this.dom.crossButton.classList.add(...selectedClasses); this.dom.tickButton.classList.remove(...originalClasses.tick.split(' ')); this.dom.tickButton.classList.add(inactiveClass); } this.dom.playerStatus.textContent = "Your answer is locked in!"; } }
            showLastRoundFeedback() { const p = this.gameModel.players.get(this.viewId); if (!p || p.lastAnswerSubmitted === null || this.gameModel.lastRoundCorrectAnswer === null) return; const myAnswerText = p.lastAnswerSubmitted ? '<strong>True</strong>' : '<strong>False</strong>'; const correctText = this.gameModel.lastRoundCorrectAnswer ? '<strong>True</strong>' : '<strong>False</strong>'; this.dom.lastQuestionFeedback.innerHTML = `Q${this.gameModel.questionNumber - 1}: Correct was ${correctText}. You said ${myAnswerText}.`; this.dom.lastQuestionFeedback.classList.remove('hidden'); }
            copyInfoToClipboard() { const c=window.sessionLobbyCode; if(!c)return; const u=window.location.href.split('?')[0];
             navigator.clipboard.writeText(`Join my Buzzer game!\n\nLink: ${APP_CONFIG.BASE_URL || u}\nCode: ${c}`)
.then(()=>alert("Copied to clipboard!")).catch(e=>console.error('Failed to copy',e));}
        }
        class AppController {
            constructor() {
                this.dom={lobby:document.getElementById('lobby-screen'),nameInput:document.getElementById('name-input'),codeInput:document.getElementById('code-input'),showCreateButton:document.getElementById('show-create-button'),showJoinButton:document.getElementById('show-join-button'),goButton:document.getElementById('go-button'),backButton:document.getElementById('back-button'),joinCreateButtons:document.getElementById('join-create-buttons'),codeEntry:document.getElementById('code-entry'),installButton:document.getElementById('install-button'),iosInstallHelper: document.getElementById('ios-install-helper')};
                this.setupLobbyListeners(); this.setupPwaListeners(); this.loadName();
            }
            setupLobbyListeners(){this.dom.showCreateButton.addEventListener('click',()=>this.showCodeEntry());this.dom.showJoinButton.addEventListener('click',()=>this.showCodeEntry());this.dom.backButton.addEventListener('click',()=>this.showMainMenu());this.dom.goButton.addEventListener('click',()=>this.joinSession());this.dom.nameInput.addEventListener('change',()=>this.saveName());}
            loadName(){const n=localStorage.getItem('buzzer_playerName');if(n)this.dom.nameInput.value=n;}
            saveName(){localStorage.setItem('buzzer_playerName',this.dom.nameInput.value);}
            showCodeEntry(){this.dom.joinCreateButtons.classList.add('hidden');this.dom.codeEntry.classList.remove('hidden');this.dom.codeInput.focus();}
            showMainMenu(){this.dom.joinCreateButtons.classList.remove('hidden');this.dom.codeEntry.classList.add('hidden');}
            setupPwaListeners() {
                let deferredPrompt;
                const isIos = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIos()) {
                    this.dom.iosInstallHelper.classList.remove('hidden');
                }
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (!isIos()) { this.dom.installButton.classList.remove('hidden'); } this.dom.installButton.addEventListener('click', () => { this.dom.installButton.classList.add('hidden'); deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; }); }); });
                if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(e => console.error('SW registration failed:', e)); }
            }
            async joinSession(){ const name=this.dom.nameInput.value.trim(); const code=this.dom.codeInput.value.trim().toUpperCase(); if(!name||!code){alert("Please enter your name and a game code!");return;} this.saveName(); window.sessionLobbyCode = code; try{ await Multisynq.Session.join({apiKey:window.APP_CONFIG.API_KEY,appId:window.APP_CONFIG.APP_ID,name:code,password:'buzzer-game-default-pw',model:GameModel,view:GameView,viewData:{name:name}}); }catch(err){console.error("LOBBY: Failed to join session:",err);alert("Could not join game. Check the code or try again.");} }
        }
        new AppController();
    </script>
</body>
</html>